import{S as fe,b as me,s as pe,n as ee,d as n,r as ge,p as de,c as re,q as M,e as D,f as a,u as V,v as _,w as _e,k as I,g as x,h as E,x as te,j as k,m as N,l as v,t as S,o as Z}from"../chunks/CcsFqX96.js";import"../chunks/IHki7fMi.js";import{captureStore as Q}from"../chunks/D_UVa_SS.js";import{A as ye,a as be,b as Re,M as xe,h as ve,s as we}from"../chunks/C2fzWeZh.js";class Te{constructor(){this.mediaRecorder=null,this.audioChunks=[],this.stream=null,this.audioContext=null,this.analyser=null,this.isRecording=!1,this.recordingStartTime=null,this.maxDurationTimeout=null}async requestPermission(){try{return this.stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:ye}}),!0}catch(e){throw console.error("Microphone permission error:",e),e.name==="NotAllowedError"?new Error("PERMISSION_DENIED"):new Error("RECORDING_ERROR")}}_getSupportedMimeType(){for(const e of be)if(MediaRecorder.isTypeSupported(e))return console.log("Using MIME type:",e),e;return console.warn("No preferred MIME type supported, using default"),""}_setupAnalyser(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.analyser.fftSize=2048,console.log("Audio analyser initialized")}catch(e){console.error("Failed to setup analyser:",e)}}async startRecording(){if(this.isRecording){console.warn("Already recording");return}this.stream||await this.requestPermission();const e=this._getSupportedMimeType();this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:e,audioBitsPerSecond:Re}),this.audioChunks=[],this.isRecording=!0,this.recordingStartTime=Date.now(),this.mediaRecorder.ondataavailable=t=>{t.data.size>0&&this.audioChunks.push(t.data)},this.mediaRecorder.start(),this._setupAnalyser(),this.maxDurationTimeout=setTimeout(()=>{this.isRecording&&(console.log("Max recording duration reached, stopping"),this.stopRecording())},xe),console.log("Recording started")}async stopRecording(){return!this.isRecording||!this.mediaRecorder?(console.warn("Not recording"),null):new Promise((e,t)=>{this.mediaRecorder.onstop=()=>{const r=new Blob(this.audioChunks,{type:this.mediaRecorder.mimeType}),o=Date.now()-this.recordingStartTime;console.log(`Recording stopped. Duration: ${o}ms, Size: ${r.size} bytes`),this.isRecording=!1,clearTimeout(this.maxDurationTimeout),e(r)},this.mediaRecorder.onerror=r=>{console.error("MediaRecorder error:",r),this.isRecording=!1,clearTimeout(this.maxDurationTimeout),t(new Error("RECORDING_ERROR"))};try{this.mediaRecorder.stop()}catch(r){console.error("Failed to stop recording:",r),this.isRecording=!1,t(r)}})}getWaveformData(){if(!this.analyser||!this.isRecording)return null;const e=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteTimeDomainData(e),e}getVolumeLevel(){if(!this.analyser||!this.isRecording)return 0;const e=new Uint8Array(this.analyser.frequencyBinCount);this.analyser.getByteTimeDomainData(e);let t=0;for(let o=0;o<e.length;o++)t+=Math.abs(e[o]-128);const r=t/e.length;return Math.min(100,r/128*100)}getRecordingDuration(){return!this.isRecording||!this.recordingStartTime?0:Math.floor((Date.now()-this.recordingStartTime)/1e3)}cancelRecording(){this.isRecording&&this.mediaRecorder&&(this.mediaRecorder.stop(),this.audioChunks=[],this.isRecording=!1,clearTimeout(this.maxDurationTimeout),console.log("Recording cancelled"))}cleanup(){this.stream&&(this.stream.getTracks().forEach(e=>{e.stop(),console.log("Audio track stopped")}),this.stream=null),this.audioContext&&this.audioContext.state!=="closed"&&(this.audioContext.close(),console.log("Audio context closed")),this.mediaRecorder=null,this.analyser=null,this.audioChunks=[],this.isRecording=!1,clearTimeout(this.maxDurationTimeout)}static isSupported(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.MediaRecorder)}}const $=new Te;function ue(s){let e,t,r=s[4].pendingCount+"",o,f,y,c;return{c(){e=v("button"),t=S("🔄 "),o=S(r),f=S(" 待同步"),this.h()},l(d){e=x(d,"BUTTON",{class:!0});var m=E(e);t=k(m,"🔄 "),o=k(m,r),f=k(m," 待同步"),m.forEach(n),this.h()},h(){_(e,"class","px-3 py-1 bg-yellow-500 text-white rounded-lg text-sm")},m(d,m){D(d,e,m),a(e,t),a(e,o),a(e,f),y||(c=V(e,"click",s[9]),y=!0)},p(d,m){m&16&&r!==(r=d[4].pendingCount+"")&&re(o,r)},d(d){d&&n(e),y=!1,c()}}}function he(s){let e,t="📵 离线模式";return{c(){e=v("span"),e.textContent=t,this.h()},l(r){e=x(r,"SPAN",{class:!0,"data-svelte-h":!0}),te(e)!=="svelte-1w2p63j"&&(e.textContent=t),this.h()},h(){_(e,"class","px-3 py-1 bg-gray-600 rounded-lg text-sm")},m(r,o){D(r,e,o)},d(r){r&&n(e)}}}function Ce(s){let e;return{c(){e=S("🎤")},l(t){e=k(t,"🎤")},m(t,r){D(t,e,r)},p:ee,d(t){t&&n(e)}}}function Ee(s){let e,t,r;return{c(){e=S("⏹ "),t=S(s[2]),r=S("s")},l(o){e=k(o,"⏹ "),t=k(o,s[2]),r=k(o,"s")},m(o,f){D(o,e,f),D(o,t,f),D(o,r,f)},p(o,f){f&4&&re(t,o[2])},d(o){o&&(n(e),n(t),n(r))}}}function De(s){let e;return{c(){e=S("点击麦克风录音，或直接输入文字")},l(t){e=k(t,"点击麦克风录音，或直接输入文字")},m(t,r){D(t,e,r)},d(t){t&&n(e)}}}function ke(s){let e;return{c(){e=S("正在录音... 最长60秒")},l(t){e=k(t,"正在录音... 最长60秒")},m(t,r){D(t,e,r)},d(t){t&&n(e)}}}function Se(s){let e,t,r,o,f="⚡ Quick Capture",y,c,d,m,b,R,z,C,w,l=s[5].loading?"保存中...":"💾 保存",q,G,X,u,W,O,Y,B,se='<a href="/" class="flex flex-col items-center text-primary-700"><span class="text-2xl">⚡</span> <span class="text-xs mt-1">捕获</span></a> <a href="/dashboard" class="flex flex-col items-center text-gray-400 hover:text-white"><span class="text-2xl">📊</span> <span class="text-xs mt-1">Dashboard</span></a> <a href="/timeline" class="flex flex-col items-center text-gray-400 hover:text-white"><span class="text-2xl">📅</span> <span class="text-xs mt-1">时间线</span></a>',J,oe,h=s[3]&&ue(s),p=!s[4].online&&he();function ie(i,g){return i[1]?Ee:Ce}let H=ie(s),T=H(s);function ae(i,g){return i[1]?ke:De}let L=ae(s),A=L(s);return{c(){e=N(),t=v("div"),r=v("header"),o=v("h1"),o.textContent=f,y=N(),c=v("div"),h&&h.c(),d=N(),p&&p.c(),m=N(),b=v("div"),R=v("textarea"),z=N(),C=v("div"),w=v("button"),q=S(l),X=N(),u=v("button"),T.c(),W=N(),O=v("p"),A.c(),Y=N(),B=v("nav"),B.innerHTML=se,this.h()},l(i){_e("svelte-1rof1hf",document.head).forEach(n),e=I(i),t=x(i,"DIV",{class:!0});var P=E(t);r=x(P,"HEADER",{class:!0});var j=E(r);o=x(j,"H1",{class:!0,"data-svelte-h":!0}),te(o)!=="svelte-14hdbc2"&&(o.textContent=f),y=I(j),c=x(j,"DIV",{class:!0});var K=E(c);h&&h.l(K),d=I(K),p&&p.l(K),K.forEach(n),j.forEach(n),m=I(P),b=x(P,"DIV",{class:!0});var U=E(b);R=x(U,"TEXTAREA",{placeholder:!0,class:!0,rows:!0}),E(R).forEach(n),z=I(U),C=x(U,"DIV",{class:!0});var F=E(C);w=x(F,"BUTTON",{class:!0});var ne=E(w);q=k(ne,l),ne.forEach(n),X=I(F),u=x(F,"BUTTON",{class:!0});var le=E(u);T.l(le),le.forEach(n),F.forEach(n),W=I(U),O=x(U,"P",{class:!0});var ce=E(O);A.l(ce),ce.forEach(n),U.forEach(n),Y=I(P),B=x(P,"NAV",{class:!0,"data-svelte-h":!0}),te(B)!=="svelte-1wssbzr"&&(B.innerHTML=se),P.forEach(n),this.h()},h(){document.title="Quick Capture",_(o,"class","text-2xl font-bold text-primary-700"),_(c,"class","flex gap-2"),_(r,"class","flex justify-between items-center mb-6"),_(R,"placeholder","记录你的想法...  Ctrl+Enter 快速提交"),_(R,"class","flex-1 w-full p-4 bg-dark-200 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-primary-700 resize-none text-lg"),_(R,"rows","10"),w.disabled=G=!s[0].trim()||s[5].loading,_(w,"class","flex-1 py-4 bg-primary-700 hover:bg-primary-600 disabled:bg-gray-700 disabled:cursor-not-allowed rounded-lg font-semibold text-lg transition-colors touch-target"),_(u,"class","px-6 py-4 rounded-lg font-semibold text-lg transition-colors touch-target"),M(u,"bg-red-500",s[1]),M(u,"hover:bg-red-600",s[1]),M(u,"bg-gray-700",!s[1]),M(u,"hover:bg-gray-600",!s[1]),_(C,"class","mt-4 flex gap-3"),_(O,"class","mt-4 text-sm text-gray-400 text-center"),_(b,"class","flex-1 flex flex-col"),_(B,"class","mt-6 flex justify-around border-t border-gray-700 pt-4"),_(t,"class","min-h-screen flex flex-col p-4")},m(i,g){D(i,e,g),D(i,t,g),a(t,r),a(r,o),a(r,y),a(r,c),h&&h.m(c,null),a(c,d),p&&p.m(c,null),a(t,m),a(t,b),a(b,R),de(R,s[0]),a(b,z),a(b,C),a(C,w),a(w,q),a(C,X),a(C,u),T.m(u,null),a(b,W),a(b,O),A.m(O,null),a(t,Y),a(t,B),J||(oe=[V(R,"input",s[10]),V(R,"keydown",s[8]),V(w,"click",s[6]),V(u,"click",s[7])],J=!0)},p(i,[g]){i[3]?h?h.p(i,g):(h=ue(i),h.c(),h.m(c,d)):h&&(h.d(1),h=null),i[4].online?p&&(p.d(1),p=null):p||(p=he(),p.c(),p.m(c,null)),g&1&&de(R,i[0]),g&32&&l!==(l=i[5].loading?"保存中...":"💾 保存")&&re(q,l),g&33&&G!==(G=!i[0].trim()||i[5].loading)&&(w.disabled=G),H===(H=ie(i))&&T?T.p(i,g):(T.d(1),T=H(i),T&&(T.c(),T.m(u,null))),g&2&&M(u,"bg-red-500",i[1]),g&2&&M(u,"hover:bg-red-600",i[1]),g&2&&M(u,"bg-gray-700",!i[1]),g&2&&M(u,"hover:bg-gray-600",!i[1]),L!==(L=ae(i))&&(A.d(1),A=L(i),A&&(A.c(),A.m(O,null)))},i:ee,o:ee,d(i){i&&(n(e),n(t)),h&&h.d(),p&&p.d(),T.d(),A.d(),J=!1,ge(oe)}}}function Ae(s,e,t){let r,o,f;Z(s,ve,l=>t(3,r=l)),Z(s,we,l=>t(4,o=l)),Z(s,Q,l=>t(5,f=l));let y="",c=!1,d=0,m;async function b(){y.trim()&&(await Q.capture(y),t(0,y=""))}async function R(){if(c){clearInterval(m);const l=await $.stopRecording();l&&await Q.captureVoice(l),t(1,c=!1),t(2,d=0)}else try{await $.startRecording(),t(1,c=!0),t(2,d=0),m=setInterval(()=>{t(2,d=$.getRecordingDuration())},1e3)}catch(l){console.error("Recording error:",l),t(1,c=!1)}}function z(l){(l.ctrlKey||l.metaKey)&&l.key==="Enter"&&b()}const C=()=>Q.syncOfflineCaptures();function w(){y=this.value,t(0,y)}return[y,c,d,r,o,f,b,R,z,C,w]}class Be extends fe{constructor(e){super(),me(this,e,Ae,Se,pe,{})}}export{Be as component};
